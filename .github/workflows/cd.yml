name: CD — Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI — Lint, Test & Build"]
    types: [completed]
    branches: ["main"]

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/fastapi-app
  K8S_NAMESPACE: fastapi-app

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    # Only deploy if CI passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag from triggering commit SHA
        id: vars
        run: |
          COMMIT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "image_tag=sha-${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.IMAGE_NAME }}:sha-${COMMIT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secret.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml
          kubectl apply -f k8s/hpa.yaml

      - name: Update Deployment image
        run: |
          kubectl set image deployment/fastapi-app \
            fastapi-app=${{ steps.vars.outputs.full_image }} \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/fastapi-app \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=120s

      - name: Verify pods are running
        run: |
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
